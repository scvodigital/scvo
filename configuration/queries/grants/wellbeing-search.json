{
  "size": 20,
  "from": {{multiply (subtract (default @root.request.params.query.page 1) 1) 20}},
  "_source": [
    "title",
    "Id",
    "recipient_name",
    "description",
    "description_alt",
    "call",
    "individuals_supported",
    "main_issue",
    "area",
    "target_group",
    "funder_name"
  ],
  "query": {
    "bool": {
      "filter": [
        {
          "term": {
            "paid_by_funder": true
          }
        }
      ],
      "must": [
        {{#ifAny @root.request.params.query.area @root.request.params.query.main_issue @root.request.params.query.target_group @root.request.params.query.call @root.request.params.query.q ~}}
        {{#if @root.request.params.query.area ~}}
        {
          "term": {
            "area-slug": "{{@root.request.params.query.area}}"
          }
        },
        {{/if ~}}
        {{#if @root.request.params.query.main_issue ~}}
        {
          "term": {
            "main_issue-slugs": "{{@root.request.params.query.main_issue}}"
          }
        },
        {{/if ~}}
        {{#if @root.request.params.query.target_group ~}}
        {
          "term": {
            "target_group-slugs": "{{@root.request.params.query.target_group}}"
          }
        },
        {{/if ~}}
        {{#if @root.request.params.query.call ~}}
        {
          "term": {
            "call-slug": "{{@root.request.params.query.call}}"
          }
        },
        {{/if ~}}
        {{#if @root.request.params.query.q ~}}
        {
          "query_string": {
            "query": {{{stringify (default @root.request.params.query.q "")}}},
            "default_field": "text_bag",
            "default_operator": "AND",
            "analyzer": "snowball"
          }
        },
        {{/if ~}}
        {
          "exists": {
            "field": "title"
          }
        }
        {{else}}
        {
          "match_all": {}
        }
        {{/ifAny ~}}
      ],
      "must_not": [
        {
          "term": {
            "recipient_name": "Community Welfare Test (CO)"
          }
        }
      ]
    }
  },
  "sort": {
    "recipient_name": "asc"
  }
}
